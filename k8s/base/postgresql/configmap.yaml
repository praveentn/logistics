apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-config
  namespace: logistics-demo
  labels:
    app: postgresql
data:
  init-databases.sh: |
    #!/bin/bash
    set -e

    echo "Creating databases for microservices..."

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
        -- Create databases for each service
        CREATE DATABASE orders_db;
        CREATE DATABASE tracking_db;
        CREATE DATABASE inventory_db;
        CREATE DATABASE notifications_db;

        -- Grant privileges
        GRANT ALL PRIVILEGES ON DATABASE orders_db TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE tracking_db TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE inventory_db TO $POSTGRES_USER;
        GRANT ALL PRIVILEGES ON DATABASE notifications_db TO $POSTGRES_USER;

        \c orders_db
        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

        \c tracking_db
        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

        \c inventory_db
        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

        \c notifications_db
        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    EOSQL

    echo "Databases created successfully!"

  postgresql.conf: |
    # Connection settings
    max_connections = 100
    shared_buffers = 128MB

    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'pg_log'
    log_filename = 'postgresql-%Y-%m-%d.log'
    log_statement = 'all'
    log_min_duration_statement = 1000

    # Performance
    effective_cache_size = 256MB
    work_mem = 4MB
